-- Learner course progress (canonical source of truth)

CREATE OR REPLACE VIEW learner_course_progress AS
SELECT
    tl.course_id,
    cl.user_id,
    LEAST(
        COALESCE(cl.completed_lessons::float / NULLIF(tl.total_lessons, 0), 0),
        1
    ) AS progress
FROM (
    SELECT
        m.course_id,
        COUNT(l.id) AS total_lessons
    FROM modules m
    JOIN lessons l ON l.module_id = m.id
    GROUP BY m.course_id
) tl
LEFT JOIN (
    SELECT
        course_id,
        user_id,
        COUNT(lesson_id) AS completed_lessons
    FROM lesson_completions
    GROUP BY course_id, user_id
) cl
ON tl.course_id = cl.course_id;

